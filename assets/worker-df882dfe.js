(function(){"use strict";var v=function(e,t,n,a){function d(r){return r instanceof n?r:new n(function(s){s(r)})}return new(n||(n=Promise))(function(r,s){function i(f){try{m(a.next(f))}catch(o){s(o)}}function y(f){try{m(a.throw(f))}catch(o){s(o)}}function m(f){f.done?r(f.value):d(f.value).then(i,y)}m((a=a.apply(e,t||[])).next())})};let h,l,c,T;onmessage=function(e){e.data.canvas&&(h=e.data.canvas,b()),e.data.opts&&(l=e.data.opts,b()),e.data.plotData&&(c=e.data.plotData,b())};function w(e,t){let n=!1;return()=>{n||(n=!0,setTimeout(()=>{n=!1,e()},t))}}let g=0;function S(){return v(this,void 0,void 0,function*(){if(!h||!l||!c)return;const{margins:e,canvasWidth:t,canvasHeight:n,visibleStartTimeSec:a,visibleEndTimeSec:d,hoveredUnitId:r,selectedUnitIds:s}=l;h.width=t,h.height=n;const i=h.getContext("2d");if(!i)return;g+=1;const y=g,m=c.plots.length,f=o=>n-e.bottom-(o+.5-0)/(m-0)*(n-e.top-e.bottom);for(const o of c?[1,2]:[1]){if(y!==g)return;const D=Date.now();(o===2||!T)&&(T=I(c));const E=u=>e.left+(u-a)/(d-a)*(t-e.left-e.right),W=c.plots.map((u,A)=>({y:f(A),x:u.spikeTimesSec.map(C=>E(C)),unitId:u.unitId,color:u.color,hovered:u.unitId===r,selected:s.includes(u.unitId)}));k(i,W);const j=Date.now()-D;yield p(j)}})}const b=w(S,10),k=(e,t)=>{if(!l)return;const{margins:n,canvasWidth:a,canvasHeight:d}=l;e.clearRect(0,0,a,d);const r=d/t.length;for(const s of[1,2,3])t.forEach(i=>{(s===1&&r>=10||s===2&&i.selected||s===3&&i.hovered)&&(e.fillStyle=s===1?i.color:s===2?"black":i.color,e.textAlign="right",e.textBaseline="middle",e.font=`${s>1?"bold ":""}12px Arial`,e.fillText(i.unitId+"",n.left-4,i.y),(s===3||s===2&&i.hovered)&&(e.textAlign="left",e.textBaseline="middle",e.font=`${s>1?"bold ":""}12px Arial`,e.fillText(i.unitId+"",a-n.right+4,i.y)))});e.save(),e.beginPath(),e.rect(n.left,n.top,a-n.left-n.right,d-n.top-n.bottom),e.clip();for(const s of[1,2])t.forEach(i=>{s===2&&i.hovered&&(e.strokeStyle="yellow",e.lineWidth=3,e.beginPath(),e.moveTo(0,i.y),e.lineTo(a,i.y),e.stroke(),e.strokeStyle="gray",e.lineWidth=1,e.beginPath(),e.moveTo(0,i.y),e.lineTo(a,i.y),e.stroke()),s===1&&i.selected&&(e.strokeStyle="lightblue",e.lineWidth=3,e.beginPath(),e.moveTo(0,i.y),e.lineTo(a,i.y),e.stroke())});t.forEach(s=>{e.strokeStyle=s.color,e.lineWidth=3,e.beginPath(),s.x.forEach(i=>{e.moveTo(i-2,s.y),e.lineTo(i+2,s.y)}),e.stroke()}),e.restore()},I=e=>{if(!l)return;const{visibleStartTimeSec:t,visibleEndTimeSec:n}=l;if(t===void 0||n===void 0)return;const a=e.plots.map(d=>Object.assign(Object.assign({},d),{spikeTimesSec:d.spikeTimesSec.filter(r=>t<=r&&r<=n)}));return Object.assign(Object.assign({},e),{plots:a})};function p(e){return new Promise(t=>{setTimeout(t,e)})}})();
